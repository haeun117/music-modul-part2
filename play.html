<script src="https://cdn.tailwindcss.com"></script>
<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Harmony Stack | Stack Play</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            borderRadius: {
              "2xl": "1.25rem"
            },
            colors: {
              ink: "rgb(var(--color-ink) / <alpha-value>)",
              surface: "rgb(var(--color-surface) / <alpha-value>)",
              muted: "rgb(var(--color-muted) / <alpha-value>)",
              accent: "rgb(var(--color-accent) / <alpha-value>)",
              accentStrong: "rgb(var(--color-accent-strong) / <alpha-value>)",
              toneA: "rgb(var(--color-tone-a) / <alpha-value>)",
              toneB: "rgb(var(--color-tone-b) / <alpha-value>)",
              toneC: "rgb(var(--color-tone-c) / <alpha-value>)"
            }
          }
        }
      };
    </script>
    <style>
      :root {
        color-scheme: light;
        --color-ink: 15 23 42;
        --color-surface: 248 250 252;
        --color-muted: 226 232 240;
        --color-accent: 78 156 255;
        --color-accent-strong: 37 99 235;
        --color-tone-a: 96 165 250;
        --color-tone-b: 248 113 113;
        --color-tone-c: 250 204 21;
      }

      body {
        margin: 0;
        font-family: "Pretendard", "Inter", system-ui, sans-serif;
        background: rgb(var(--color-surface));
        color: rgb(var(--color-ink));
        min-height: 100vh;
      }

      .tower-area {
        position: relative;
        height: 520px;
        overflow: hidden;
        border-radius: 1.25rem;
        background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%);
        border: 1px solid rgb(var(--color-muted));
      }

      .block {
        position: absolute;
        height: 36px;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
      }

      .shake {
        animation: shake 0.2s ease-in-out 3;
      }

      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-6px);
        }
        50% {
          transform: translateX(6px);
        }
        75% {
          transform: translateX(-4px);
        }
        100% {
          transform: translateX(0);
        }
      }

      .confetti::before,
      .confetti::after {
        content: "";
        position: absolute;
        inset: 0;
        background-image: radial-gradient(circle at 10% 20%, #fbbf24 0 6px, transparent 7px),
          radial-gradient(circle at 80% 30%, #34d399 0 5px, transparent 6px),
          radial-gradient(circle at 30% 70%, #60a5fa 0 6px, transparent 7px),
          radial-gradient(circle at 70% 80%, #f472b6 0 5px, transparent 6px);
        opacity: 0.5;
        animation: confetti 1.2s ease-in-out infinite;
      }

      @keyframes confetti {
        0% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(10px);
        }
      }
    </style>
  </head>
  <body>
    <main class="min-h-screen px-6 py-8">
      <div class="mx-auto flex w-full max-w-6xl flex-col gap-6">
        <header class="rounded-2xl bg-white p-5 shadow-soft border border-muted">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-sm font-semibold text-slate-500">Harmony Stack</p>
              <h1 class="text-3xl font-bold">Stack Play</h1>
            </div>
            <a
              href="index.html"
              class="min-h-[44px] rounded-2xl border border-muted bg-white px-5 py-2 text-sm font-semibold"
            >
              Back to Mode Select
            </a>
          </div>
        </header>

        <section class="grid gap-6 lg:grid-cols-[1.5fr_1fr]">
          <div class="flex flex-col gap-4">
            <div class="rounded-2xl bg-white p-5 shadow-soft border border-muted">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                  <div class="rounded-2xl bg-slate-50 px-4 py-2 text-sm font-semibold">
                    Floor <span id="floorCount">1</span>
                  </div>
                  <div class="flex flex-col gap-2">
                    <div class="text-xs font-semibold text-slate-500">안정도</div>
                    <div class="h-3 w-44 overflow-hidden rounded-full bg-muted">
                      <div
                        id="stabilityFill"
                        class="h-full rounded-full bg-accent transition"
                        style="width: 100%"
                      ></div>
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-4 text-sm font-semibold text-slate-600">
                  <div
                    id="missionText"
                    class="hidden rounded-full bg-accent/10 px-3 py-1 text-accentStrong"
                  ></div>
                </div>
              </div>
            </div>

            <div class="tower-area" id="towerArea">
              <div
                id="floatingBlock"
                class="block bg-accent"
                style="top: 32px; left: 50%; width: 240px"
              >
                ♩
              </div>
              <div id="towerBase"></div>
              <div
                id="resultBanner"
                class="pointer-events-none absolute left-1/2 top-6 hidden -translate-x-1/2 rounded-full bg-red-500/90 px-4 py-2 text-sm font-semibold text-white"
              ></div>
            </div>

            <p id="tapHint" class="text-center text-sm font-semibold text-slate-500">
              화면을 탭하여 블록을 놓아주세요.
            </p>
          </div>

          <aside class="flex flex-col gap-4">
            <div class="rounded-2xl bg-white p-5 shadow-soft border border-muted">
              <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold">음 패널</h2>
                <span
                  id="soundStatus"
                  class="rounded-full bg-slate-100 px-2 py-1 text-xs font-semibold text-slate-500"
                >
                  Sound OFF
                </span>
              </div>
              <div id="toneSelector" class="mt-4 hidden">
                <p class="text-xs font-semibold text-slate-500">블록 선택</p>
                <div class="mt-2 grid grid-cols-3 gap-2">
                  <button
                    type="button"
                    class="tone-button min-h-[44px] rounded-xl border border-muted bg-white text-sm font-semibold"
                    data-tone="A"
                  >
                    A
                  </button>
                  <button
                    type="button"
                    class="tone-button min-h-[44px] rounded-xl border border-muted bg-white text-sm font-semibold"
                    data-tone="B"
                  >
                    B
                  </button>
                  <button
                    type="button"
                    class="tone-button min-h-[44px] rounded-xl border border-muted bg-white text-sm font-semibold"
                    data-tone="C"
                  >
                    C
                  </button>
                </div>
              </div>

              <div class="mt-4 rounded-2xl bg-slate-50 p-4">
                <p class="text-xs font-semibold text-slate-500">누적 음</p>
                <div id="toneHistory" class="mt-3 grid grid-cols-6 gap-2 text-center text-xs"></div>
              </div>
            </div>

            <div class="rounded-2xl bg-white p-5 shadow-soft border border-muted">
              <h3 class="text-lg font-semibold">미션 예시</h3>
              <ul class="mt-3 space-y-2 text-sm text-slate-600" id="missionExamples"></ul>
            </div>

            <div class="rounded-2xl bg-white p-5 shadow-soft border border-muted">
              <h3 class="text-lg font-semibold">설정값</h3>
              <ul class="mt-3 space-y-2 text-sm text-slate-600" id="settingsList"></ul>
            </div>
          </aside>
        </section>
      </div>
    </main>

    <script>
      const gradeStyles = {
        low: { accent: "120 213 111", strong: "34 197 94" },
        mid: { accent: "78 156 255", strong: "37 99 235" },
        high: { accent: "244 124 255", strong: "217 70 239" }
      };

      const toneStyles = {
        A: { color: "toneA", icon: "♪", freq: 440 },
        B: { color: "toneB", icon: "♬", freq: 523.25 },
        C: { color: "toneC", icon: "♫", freq: 659.25 }
      };

      const missionSets = {
        low: [
          {
            id: "low-stack-6",
            title: "6층 쌓기",
            description: "정확하게 6층을 만들어 보세요."
          },
          {
            id: "low-steady-5",
            title: "흔들림 없이 5층 유지",
            description: "흔들림 없이 5층까지 쌓아요."
          }
        ],
        mid: [
          {
            id: "mid-balance-7",
            title: "7층 균형 쌓기",
            description: "안정도 60 이상을 유지하세요."
          },
          {
            id: "mid-stack-8",
            title: "8층 쌓기",
            description: "정확하게 8층을 완성하세요."
          }
        ],
        high: [
          {
            id: "high-bright-8",
            title: "밝은 화음으로 8층 쌓기",
            description: "A/B/C 중 2개 이상 음으로 8층."
          },
          {
            id: "high-mono-10",
            title: "단화음만 사용해서 타워 완성",
            description: "한 가지 음만으로 10층을 쌓아요."
          }
        ]
      };

      const params = new URLSearchParams(window.location.search);
      const grade = params.get("grade") || "mid";
      const mission = params.get("mission") === "1";
      const sound = params.get("sound") !== "0";
      const classmode = params.get("classmode") === "1";

      const palette = gradeStyles[grade] || gradeStyles.mid;
      document.documentElement.style.setProperty("--color-accent", palette.accent);
      document.documentElement.style.setProperty(
        "--color-accent-strong",
        palette.strong
      );

      const settingsList = document.getElementById("settingsList");
      settingsList.innerHTML = `
        <li>학년 모드: <strong>${grade}</strong></li>
        <li>미션: <strong>${mission ? "ON" : "OFF"}</strong></li>
        <li>시간: <strong>사용 안 함</strong></li>
        <li>사운드: <strong>${sound ? "ON" : "OFF"}</strong></li>
        <li>수업용 모드: <strong>${classmode ? "ON" : "OFF"}</strong></li>
      `;

      const floorCount = document.getElementById("floorCount");
      const stabilityFill = document.getElementById("stabilityFill");
      const towerArea = document.getElementById("towerArea");
      const floatingBlock = document.getElementById("floatingBlock");
      const towerBase = document.getElementById("towerBase");
      const resultBanner = document.getElementById("resultBanner");
      const missionText = document.getElementById("missionText");
      const missionExamples = document.getElementById("missionExamples");
      const tapHint = document.getElementById("tapHint");
      const soundStatus = document.getElementById("soundStatus");
      const toneHistory = document.getElementById("toneHistory");
      const toneSelector = document.getElementById("toneSelector");
      const toneButtons = Array.from(document.querySelectorAll(".tone-button"));

      const state = {
        floor: 1,
        stability: 100,
        blockWidth: 240,
        currentX: 0,
        direction: 1,
        speed: 1.8,
        prevX: null,
        selectedTone: "A",
        missionCompleted: false,
        missionFailed: false,
        shakeCount: 0,
        usedTones: new Set()
      };

      let animationId;

      const activeMissions = missionSets[grade] || missionSets.mid;
      const activeMission = activeMissions[0];

      function updateMissionText() {
        if (!mission || !activeMission) return;
        missionText.textContent = activeMission.title;
        missionText.classList.remove("hidden");
      }

      function renderMissionExamples() {
        const items = activeMissions
          .map((item) => `<li><strong>${item.title}</strong> - ${item.description}</li>`)
          .join("");
        missionExamples.innerHTML = items;
      }

      function updateSoundStatus() {
        soundStatus.textContent = sound ? "Sound ON" : "Sound OFF";
        soundStatus.classList.toggle("bg-accent/10", sound);
        soundStatus.classList.toggle("text-accentStrong", sound);
      }

      function updateHint() {
        tapHint.textContent = classmode ? "탭하여 놓기" : "화면을 탭하여 블록을 놓아주세요.";
      }

      function updateToneSelector() {
        if (grade === "high") {
          toneSelector.classList.remove("hidden");
        } else {
          toneSelector.classList.add("hidden");
        }
        toneButtons.forEach((button) => {
          const isActive = button.dataset.tone === state.selectedTone;
          button.classList.toggle("bg-accent", isActive);
          button.classList.toggle("text-white", isActive);
          button.classList.toggle("border-accentStrong", isActive);
        });
      }

      function updateFloatingBlockTone() {
        const tone = toneStyles[state.selectedTone];
        floatingBlock.textContent = tone.icon;
        floatingBlock.classList.remove("bg-toneA", "bg-toneB", "bg-toneC");
        floatingBlock.classList.add(`bg-${tone.color}`);
      }

      let audioContext;

      function ensureAudioContext() {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioContext.state === "suspended") {
          audioContext.resume();
        }
      }

      function playTone(toneKey) {
        if (!sound) return;
        ensureAudioContext();
        const tone = toneStyles[toneKey];
        if (!tone || !audioContext) return;
        const oscillator = audioContext.createOscillator();
        const gain = audioContext.createGain();
        oscillator.type = "sine";
        oscillator.frequency.value = tone.freq;
        gain.gain.value = 0;
        oscillator.connect(gain);
        gain.connect(audioContext.destination);
        const now = audioContext.currentTime;
        gain.gain.linearRampToValueAtTime(0.25, now + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.25);
        oscillator.start(now);
        oscillator.stop(now + 0.3);
      }

      function addToneHistory() {
        const tone = toneStyles[state.selectedTone];
        const chip = document.createElement("div");
        chip.className = `rounded-lg py-2 text-white font-semibold bg-${tone.color}`;
        chip.textContent = tone.icon;
        toneHistory.prepend(chip);
        state.usedTones.add(state.selectedTone);
      }

      function updateStability(delta) {
        state.stability = Math.max(0, state.stability - delta);
        stabilityFill.style.width = `${state.stability}%`;
        if (state.stability < 35 && !state.missionFailed) {
          resultBanner.textContent = "미션 실패";
          resultBanner.classList.remove("hidden");
          state.missionFailed = true;
        }
      }

      function showBanner(text, confetti) {
        resultBanner.textContent = text;
        resultBanner.classList.remove("hidden");
        if (confetti) {
          resultBanner.classList.add("confetti");
        } else {
          resultBanner.classList.remove("confetti");
        }
      }

      function checkMission() {
        if (!mission || state.missionCompleted || !activeMission) return;
        const tonesUsed = state.usedTones.size;
        const floor = state.floor;
        if (activeMission.id === "low-stack-6" && floor >= 6) {
          state.missionCompleted = true;
        }
        if (activeMission.id === "low-steady-5" && floor >= 5 && state.shakeCount === 0) {
          state.missionCompleted = true;
        }
        if (activeMission.id === "mid-balance-7" && floor >= 7 && state.stability >= 60) {
          state.missionCompleted = true;
        }
        if (activeMission.id === "mid-stack-8" && floor >= 8) {
          state.missionCompleted = true;
        }
        if (activeMission.id === "high-bright-8" && floor >= 8 && tonesUsed >= 2) {
          state.missionCompleted = true;
        }
        if (activeMission.id === "high-mono-10" && floor >= 10 && tonesUsed === 1) {
          state.missionCompleted = true;
        }
        if (state.missionCompleted) {
          showBanner("미션 성공", true);
        }
      }

      function updateFloor() {
        floorCount.textContent = state.floor;
      }

      function setFloatingBlockPosition(x) {
        const towerWidth = towerArea.clientWidth;
        const maxX = towerWidth - state.blockWidth;
        state.currentX = Math.max(0, Math.min(x, maxX));
        floatingBlock.style.left = `${state.currentX}px`;
        floatingBlock.style.width = `${state.blockWidth}px`;
      }

      function animate() {
        const towerWidth = towerArea.clientWidth;
        const maxX = towerWidth - state.blockWidth;
        let nextX = state.currentX + state.direction * state.speed;
        if (nextX <= 0 || nextX >= maxX) {
          state.direction *= -1;
          nextX = Math.max(0, Math.min(nextX, maxX));
        }
        setFloatingBlockPosition(nextX);
        animationId = requestAnimationFrame(animate);
      }

      function placeBlock() {
        if (state.blockWidth <= 40) {
          showBanner("미션 실패", false);
        }
        const towerWidth = towerArea.clientWidth;
        const maxX = towerWidth - state.blockWidth;
        let targetX = state.currentX;
        if (grade === "low" && state.prevX !== null) {
          const center = state.prevX + state.blockWidth / 2;
          const currentCenter = targetX + state.blockWidth / 2;
          const snappedCenter = currentCenter + (center - currentCenter) * 0.5;
          targetX = snappedCenter - state.blockWidth / 2;
          targetX = Math.max(0, Math.min(targetX, maxX));
        }

        const prevCenter = state.prevX !== null ? state.prevX + state.blockWidth / 2 : targetX + state.blockWidth / 2;
        const currentCenter = targetX + state.blockWidth / 2;
        const offset = Math.abs(currentCenter - prevCenter);
        const shrink = Math.min(state.blockWidth * 0.6, offset);
        state.blockWidth = Math.max(36, state.blockWidth - shrink);
        updateStability(Math.round(offset / 4));

        if (offset > 40) {
          towerArea.classList.add("shake");
          state.shakeCount += 1;
          setTimeout(() => towerArea.classList.remove("shake"), 600);
        }

        const stackedBlock = document.createElement("div");
        stackedBlock.className = `block bg-${toneStyles[state.selectedTone].color}`;
        stackedBlock.style.width = `${state.blockWidth}px`;
        stackedBlock.style.left = `${targetX}px`;
        stackedBlock.style.bottom = `${(state.floor - 1) * 40 + 12}px`;
        stackedBlock.textContent = toneStyles[state.selectedTone].icon;
        towerBase.appendChild(stackedBlock);

        state.prevX = targetX;
        state.floor += 1;
        updateFloor();
        addToneHistory();
        playTone(state.selectedTone);
        checkMission();
      }

      function handleTap() {
        placeBlock();
        setFloatingBlockPosition(state.currentX);
      }

      towerArea.addEventListener("click", handleTap);
      document.addEventListener("keydown", (event) => {
        if (event.code === "Space") {
          event.preventDefault();
          handleTap();
        }
      });

      toneButtons.forEach((button) => {
        button.addEventListener("click", () => {
          state.selectedTone = button.dataset.tone;
          updateToneSelector();
          updateFloatingBlockTone();
        });
      });

      updateMissionText();
      renderMissionExamples();
      updateSoundStatus();
      updateHint();
      updateToneSelector();
      updateFloatingBlockTone();
      setFloatingBlockPosition(towerArea.clientWidth / 2 - state.blockWidth / 2);
      updateFloor();
      animationId = requestAnimationFrame(animate);
    </script>
  </body>
</html>
